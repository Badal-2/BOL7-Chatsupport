  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOL7 Chat Support  </title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    html, body {
        height: 100%;
        overflow: hidden;
    }
    
    body {
        font-family: 'Outfit', sans-serif;
        background: #EDEDED;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #chat-container {
        width: 100%;
        height: 100vh;
        max-width: 100%;
        background: #FFFFFF;
        display: flex;
        flex-direction: column;
        color: #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    /* Header Container */
    .header-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        background: linear-gradient(135deg, #075E54 0%, #128C7E 100%);
        flex-shrink: 0;
    }

    .header-container h2 {
        padding: 0;
        margin: 0;
        background: none;
        color: white;
        font-size: 18px;
        font-weight: 600;
    }

    #upload-btn {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        color: white;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    #upload-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Messages Container - FIXED HEIGHT */
    #messages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        background: #ECE5DD;
        color: #333;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Custom Scrollbar */
    #messages::-webkit-scrollbar {
        width: 4px;
    }

    #messages::-webkit-scrollbar-track {
        background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
        background: #128C7E;
        border-radius: 10px;
    }

    /* Message Styles */
    .message {
        margin: 0;
        padding: 10px 12px;
        max-width: 80%;
        word-wrap: break-word;
        display: flex;
        align-items: flex-start;
        font-size: 14px;
        line-height: 1.5;
        animation: messageSlide 0.3s ease-out;
        gap: 6px;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .user {
        background: linear-gradient(135deg, #DCF8C6 0%, #C8E6C9 100%);
        color: #333;
        align-self: flex-end;
        border-radius: 16px 16px 4px 16px;
        margin-left: auto;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        animation: messageSlideRight 0.3s ease-out;
        max-width: 75%;
    }

    @keyframes messageSlideRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .bot {
        background: #ffffff;
        color: #333;
        align-self: flex-start;
        border-radius: 16px 16px 16px 4px;
        border: 1px solid #E0E0E0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        max-width: 85%;
    }

    .icon {
        margin-right: 6px;
        font-size: 16px;
        flex-shrink: 0;
    }

    /* Input Container - FIXED AT BOTTOM */
    #input-container {
        display: flex;
        align-items: center;
        width: 100%;
        background: #FFFFFF;
        padding: 12px;
        gap: 8px;
        border-top: 1px solid #E0E0E0;
        flex-shrink: 0;
    }

    #user-input {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: #F8F8F8;
        color: #333;
        font-size: 14px;
        font-family: 'Outfit', sans-serif;
        border-radius: 22px;
        transition: all 0.3s ease;
        min-width: 0;
    }

    #user-input:focus {
        outline: none;
        background: #fff;
        box-shadow: 0 0 0 2px #128C7E;
    }

    #user-input::placeholder {
        color: #999;
    }

    /* Buttons */
    button {
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    #send-button, #voice-input {
        background: linear-gradient(135deg, #075E54 0%, #128C7E 100%);
        color: #ffffff;
        width: 42px;
        height: 42px;
    }

    #send-button:active, #voice-input:active {
        transform: scale(0.95);
    }

    /* Loading Spinner */
    .loading-spinner {
        display: inline-block;
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #128C7E;
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
        margin-right: 6px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Links */
    .clickable-link {
        color: #128C7E;
        text-decoration: underline;
        cursor: pointer;
        font-weight: 500;
        word-break: break-all;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 10% auto;
        width: 90%;
        max-width: 500px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .modal-header h3 {
        margin: 0;
        color: #075E54;
        font-size: 18px;
    }

    .close-modal {
        font-size: 28px;
        color: #999;
        cursor: pointer;
        line-height: 1;
    }

    .modal-body {
        padding: 20px;
    }

    .upload-area {
        border: 2px dashed #128C7E;
        border-radius: 10px;
        padding: 30px 15px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
    }

    .upload-icon {
        font-size: 40px;
        color: #128C7E;
        margin-bottom: 10px;
    }

    .upload-area p {
        color: #666;
        margin: 10px 0;
        font-size: 13px;
    }

    .browse-btn {
        margin-top: 12px;
        padding: 10px 20px;
        background: #128C7E;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    #file-info {
        margin-top: 15px;
        padding: 12px;
        background: #e8f5f3;
        border-radius: 8px;
        font-size: 13px;
    }

    #file-info p {
        margin: 5px 0;
        color: #333;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #128C7E 0%, #075E54 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    #progress-text {
        text-align: center;
        color: #666;
        font-size: 13px;
    }

    #upload-result {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
    }

    #upload-result.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    #upload-result.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .modal-footer {
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        position: sticky;
        bottom: 0;
        background: white;
    }

    .modal-footer button {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #upload-submit-btn {
        background: #128C7E;
        color: white;
    }

    #upload-submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .cancel-btn {
        background: #f0f0f0;
        color: #333;
    }

    /* Mobile Specific - NO MEDIA QUERIES NEEDED! */
    /* Everything is already mobile-first! */
    
    /* Only adjust for very small screens */
    @media (max-width: 360px) {
        .header-container h2 {
            font-size: 16px;
        }
        
        .message {
            font-size: 13px;
            padding: 8px 10px;
        }
        
        #user-input {
            font-size: 13px;
            padding: 10px 14px;
        }
        
        #send-button, #voice-input {
            width: 38px;
            height: 38px;
            font-size: 16px;
        }
    }

    /* Desktop improvements */
    @media (min-width: 768px) {
        body {
            padding: 20px;
        }
        
        #chat-container {
            max-width: 600px;
            height: 90vh;
            border-radius: 15px;
            border: 1px solid #D9D9D9;
        }
        
        .header-container {
            border-radius: 15px 15px 0 0;
        }
        
        .message {
            max-width: 70%;
        }
    }
</style>


</head>
<body>

    <div id="chat-container">
    <div class="header-container">
        <h2>BOL7 Chat Support</h2>
        <button id="upload-btn" onclick="openUploadModal()" title="Upload PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
    </div>

    <!-- PDF Upload Modal -->
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload PDF Document</h3>
            <span class="close-modal" onclick="closeUploadModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p>Drag & Drop PDF here or click to browse</p>
                <input type="file" id="pdf-file-input" accept=".pdf" onchange="handleFileSelect(event)" style="display: none;">
                <button onclick="document.getElementById('pdf-file-input').click()" class="browse-btn">
                    Browse Files
                </button>
            </div>
            <div id="file-info" style="display: none;">
                <p><strong>Selected:</strong> <span id="file-name"></span></p>
                <p><strong>Size:</strong> <span id="file-size"></span></p>
            </div>
            <div id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <p id="progress-text">Processing...</p>
            </div>
            <div id="upload-result" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button id="upload-submit-btn" onclick="uploadPDF()" disabled>
                <i class="fas fa-upload"></i> Upload
            </button>
            <button onclick="closeUploadModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

        <div id="messages">
            <div class="message bot">
                <i class="fas fa-robot icon"></i>
                <span>Hello! How can I assist you with BOL7 products and services today?</span>
            </div>
        </div>
        <div id="input-container">
            <button id="voice-input" onclick="startVoiceInput()">
                <i class="fas fa-microphone-alt"></i>
            </button>
            <input type="text" id="user-input" placeholder="Write your message..." onkeydown="handleKeyPress(event)">
            <button id="send-button" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>


<!-- üî¥üî¥üî¥üî¥üî¥ -->






<script>
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const userMessage = input.value;
        if (!userMessage) return;
        input.value = '';

        const userMessageElement = document.createElement('div');
        userMessageElement.className = 'message user';
        userMessageElement.innerHTML = `<span>${userMessage}</span>`;
        document.getElementById('messages').appendChild(userMessageElement);
        scrollToBottom();

        const uniqueId = `bot-text-${Date.now()}`;
        const botMessageElement = document.createElement('div');
        botMessageElement.className = 'message bot';
        botMessageElement.innerHTML = `<span class="loading-spinner"></span><i class="fas fa-robot icon"></i><span id="${uniqueId}"></span>`;
        document.getElementById('messages').appendChild(botMessageElement);
        const botTextElement = document.getElementById(uniqueId);
        scrollToBottom();

        try {
           const response = await fetch('/api/chatbot/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: userMessage  // ‚úÖ Dynamic user input
    })
});
        
            const data = await response.json();
            const botReply = data.llm_response  || "Sorry, no reply.";


            // STEP 1: Request voice generation BEFORE typing starts
            const formData = new FormData();
            formData.append('message', botReply);

          //  const voiceRes = await fetch('/generate1/', {
        //    method: 'POST',
          //      body: formData
            //});

           // const voiceData = await voiceRes.json();
            const spinner = botMessageElement.querySelector('.loading-spinner');
            if (spinner) spinner.remove();

            const ttsResponse = await fetch('/api/tts/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: botReply,
                language: 'en'
            })
        });

            const ttsData = await ttsResponse.json();
            // Play audio if available
            if (ttsData.success && ttsData.audio_url) {
                const audio = new Audio(ttsData.audio_url);
                audio.play().catch(err => console.warn("Audio playback failed:", err));
        }

    

        

        




            // STEP 2: Play audio and type at the same time
           // if (voiceData.voice_url) {
             //   const audio = new Audio(voiceData.voice_url);''
                
               // audio.playbackRate = 1.3;  // Change this to any desired speed (0.5 to 2.0)
                //audio.play().catch(err => console.warn("Audio playback failed:", err));
           // }

            typingEffect(botReply, botTextElement);

        } catch (error) {
            console.error("Error:", error);
            botTextElement.textContent = "Something went wrong. Please try again.";
            const spinner = botMessageElement.querySelector('.loading-spinner');
            if (spinner) spinner.remove();
        }
    }

    function typingEffect(text, element) {
        let i = 0;
        const speed = 20;
        const urlRegex = /(https?:\/\/[^\s\]]+[^\s.,;:!?)\]]*[^\s.,;:!?)\]])/g;
        const processedText = text.replace(urlRegex, (match) => {
            const url = match.replace(/[.,;:!?)]+$/, '');
            const punctuation = match.slice(url.length);
            return `<a href="${url}" class="clickable-link" target="_blank">${url}</a>${punctuation}`;
        });

        function type() {
            if (i < processedText.length) {
                if (processedText.substring(i).startsWith('<a href=')) {
                    const endIndex = processedText.indexOf('</a>', i) + 4;
                    element.innerHTML += processedText.substring(i, endIndex);
                    i = endIndex;
                } else {
                    element.innerHTML += processedText[i];
                    i++;
                }
                setTimeout(type, speed);
                scrollToBottom();
            }
        }

        type();
    }

    function scrollToBottom() {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function startVoiceInput() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = true;

        recognition.start();

        recognition.onspeechstart = function() {
            console.log("Speech has been detected.");
        };

        recognition.onresult = function(event) {
            const voiceText = event.results[0][0].transcript;
            document.getElementById('user-input').value = voiceText;
            sendMessage();
        };

        recognition.onspeechend = function() {
            console.log("Speech has stopped.");
            recognition.stop();
        };

        recognition.onerror = function(event) {
            alert('Error occurred in recognition: ' + event.error);
            console.log('Error: ', event);
        };
    }

    // PDF Upload Functions
let selectedFile = null;

function openUploadModal() {
    document.getElementById('upload-modal').style.display = 'block';
}

function closeUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    resetUploadForm();
}

function resetUploadForm() {
    selectedFile = null;
    document.getElementById('pdf-file-input').value = '';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('upload-result').style.display = 'none';
    document.getElementById('upload-submit-btn').disabled = true;
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        validateAndSetFile(file);
    }
}

function validateAndSetFile(file) {
    // Validate file type
    if (!file.name.endsWith('.pdf')) {
        alert('Please select a PDF file');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File too large! Maximum size is 10MB');
        return;
    }
    
    selectedFile = file;
    
    // Show file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('upload-submit-btn').disabled = false;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

async function uploadPDF() {
    if (!selectedFile) {
        alert('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf_file', selectedFile);
    
    // Show progress
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('upload-result').style.display = 'none';
    document.getElementById('upload-submit-btn').disabled = true;
    
    // Animate progress
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        if (progress <= 90) {
            progressFill.style.width = progress + '%';
        }
    }, 200);
    
    progressText.textContent = 'Extracting text from PDF...';
    
    try {
        const response = await fetch('/api/upload-pdf/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        
        setTimeout(() => {
            document.getElementById('upload-progress').style.display = 'none';
            
            const resultDiv = document.getElementById('upload-result');
            resultDiv.style.display = 'block';
            
            if (data.success) {
                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Success!</strong><br>
                    ${data.message}<br>
                    <small>Added ${data.data.saved_chunks} entries from ${data.data.filename}</small>
                `;
                
                setTimeout(() => {
                    closeUploadModal();
                }, 3000);
            } else {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Error</strong><br>
                    ${data.error}
                `;
            }
        }, 500);
        
    } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('upload-progress').style.display = 'none';
        
        const resultDiv = document.getElementById('upload-result');
        resultDiv.style.display = 'block';
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
            <strong>‚ùå Upload Failed</strong><br>
            ${error.message}
        `;
    }
}

// Drag and drop support
const uploadArea = document.getElementById('upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        validateAndSetFile(files[0]);
    }
});

// Close modal on outside click
window.onclick = function(event) {
    const modal = document.getElementById('upload-modal');
    if (event.target === modal) {
        closeUploadModal();
    }
}


</script>
</body>
</html>
